---
title: PHP应用&文件管理模块&显示上传&黑白名单类型过滤&访问控制
published: 2025-10-14
description: PHP文件管理模块上传黑名单、白名单、MINE过滤，以及path路径赋值案例。
tags: [PHP,安全开发]
category: 网络安全
draft: false
---

# PHP应用&文件管理模块&显示上传&黑白名单类型过滤&访问控制

## 文件管理模块-上传-过滤机制

1. 无过滤机制
2. 黑名单过滤机制
3. 白名单过滤机制
4. 文件类型过滤机制

### $_FILES

`$_FILES`：PHP中一个预定义的超全局变量，用于在上传文件时从客户端接收文件，并将其保存到服务器上。它是一个包含上传文件信息的数组，包括文件名、类型、大小、临时文件名等信息。

`$_FILES`：`[" 表单值 "]["name"]` 获取上传文件原始名称。

`$_FILES`：`[" 表单值 "]["type"]`获取上传文件MIME类型。

`$_FILES`：`[" 表单值 "]["size"]`获取上传文件字节单位大小。

`$_FILES`：`[" 表单值 "]["tmp_name"]`获取上传的临时副本文件名。

`$_FILES`：`[" 表单值 "]["error"]`获取上传时发生的错误代码。

`move_uploaded_file()`将上传的文件移动到指定位置的函数。

### error类型（8种）

0：没有错误，上传成功。

1：上传的文件超过了php.ini（php配置文件，用于配置php运行时环境的各种参数以及选项）中upload_max_filesize选项限制的值。

2：上传的文件的大小超过了html表单中MAX_FILE_SIZE选项指定的值。

3：文件只有部分被上传。

4：没有文件被上传。

6：找不到临时文件夹（php4.3.0、php5.0.3引进）。

7：文件写入失败（php5.1.0引进）。

8：文件上传被一个PHP扩展程序停止。如：file_uploads被禁用，或者某些扩展（如mod_security）阻止了文件上传。

## 文件上传案例

### 文件上传

这部分就不过多说明，因为代码中出现的都在文章上方包含。

```php
<?php
$name=$_FILES['f']['name'];
$type=$_FILES['f']['type'];
$size=$_FILES['f']['size'];
$tmp_name=$_FILES['f']['tmp_name'];
$error=$_FILES['f']['error'];
 
echo $name.'<br>';
echo $type.'<br>';
echo $size.'<br>';
echo $tmp_name.'<br>';
echo $error.'<br>';
?>
```

### 黑名单机制

黑名单机制虽然可以防止一些非法文件的上传，但是还是有一定的缺陷，比如一些意想不到的后缀没有被加入黑名单，就可以进行绕过。

就例如只拦截了`.php`后缀命名的文件，但是如果把后缀改为其他的，比如`.php1`或者`.php5`这些都无法有效的被拦截到。

```php
<?php
$black_ext=array('php','asp','jsp','aspx');     // array（）数组
//xxx.jpg xxx.png
$fenge=explode('.',$name);                      // explode（）以.来拆分后缀名
$exts=end($fenge);                              // 将数组的值获取出来，从而得到变量
if (in_array($exts,$black_ext)){                // 判断$exts是否在$black_ext中
    echo '非法后缀文件'.$exts;		// 这里加不加文件后缀无所谓
}else{
    move_uploaded_file($tmp_name,'upload/'.$name);  
// needle针:$exts,haystack大海捞针：$black_exts
    echo "<script>alert('上传成功')</script>";
}
?>
```

### 白名单机制

与黑名单相反，白名单就是对允许上传的类型进行放行，其他的类型一律被判定为非法后缀。

但是白名单也有绕过的可能性，现在还没有学习到后期会补充上。--2025/10/14

```php
<?php
$allow_ext=array('png','jpg','gif','jpeg');
$fenge=explode('.',$name);
$exts=end($fenge);
if (!in_array($exts,$allow_ext)){
    echo '非法后缀文件'.$exts;
}else{
    move_uploaded_file($tmp_name,'upload/'.$name);
    echo "<script>alert('上传成功')</script>";
}
?>
```

### MIME文件类型过滤

MINE通过抓包对包里面的字段进行修改就可以实现绕过。

意思就是不管上传什么后缀的，只需要把抓包抓到的Content-Type进行修改即可绕过。

```php
<?php
$allow_type = array('image/jpg','image/jpeg', 'image/png', 'image/gif');
if(!in_array($type,$allow_type)){
    echo '非法后缀文件'.$type;
}else{
    move_uploaded_file($tmp_name,'upload/'.$name);
    echo '<script>alert("上传成功")</script>';
}
?>
```

## 文件管理模块—显示—过滤机制

功能：显示、上传、下载、删除、编辑、包含等

1. 打开目录读取文件列表
2. 递归循环读取文件列表
3. 判断是文件还是文件夹（编辑功能 文件夹改名 文件改内容）
4. PHP.INI 目录访问控制

### 相关函数

is_dir() 函数用于检查指定的路径是否是一个目录。

opendir() 函数用于打开指定的目录，返回句柄，用来读取目录中的文件和子目录。

readdir() 函数用于从打开的目录句柄中读取目录中的文件和子目录。

open_basedir：PHP.INI中的设置用来控制脚本程序访问目录。

### 文件显示案例

文件显示代码如下：

```php
<?php
// $dir='./';    //当前目录
$dir=$_GET['path'] ?? './';    // 设置path的值给$dir,没有的话为当前目录
function show_file($dir){
    $d=opendir($dir);  // 可以为此加个函数function show_file($dir){}
    while(($file=readdir($d)) !== false){  // $file=readdir($d)将打开的值给file
        // 若file不等于false就循环打出全部数据（还有文件or文件夹）
//    echo $file."<br>";
        if (is_dir($file)){
            echo "文件夹".$file."<br>";
        }else{
            echo "文件".$file."<br>";
        }
    }
}
 
show_file($dir);
?>
```

![](https://cdn.jsdelivr.net/gh/PWN022/0x00@main/NetSecurity/My_screenshot/24-01.png)

#### path赋值

可以打开对于的文件夹，或使用?path=../去到上一级。



![](https://cdn.jsdelivr.net/gh/PWN022/0x00@main/NetSecurity/My_screenshot/24-02.png)

![](https://cdn.jsdelivr.net/gh/PWN022/0x00@main/NetSecurity/My_screenshot/24-03.png)

#### 文件跳转

来触发亮的标签，在网页中直接点击即可进入其他文件夹。

```php
if(is_dir($file)){
            echo '文件夹：'."<a href='?path=$file'>$file</a>".'<br>';
}
```

### php.ini安全机制

#### 文件遍历漏洞

在phpstudy中找到php.ini。

打开php.ini找到open_basedir。

> open_dir开了则../../回显空白或报错(重新启动phpstudy），
>
> open_dir关了则../../可以到C盘/D盘比如？path=c:/windows。

具体参考：https://blog.csdn.net/m0_74930529/article/details/143273160

以上案例的对应方案：

1. 打开open_basedir
2. 对../过滤
3. 对于文件权限进行设置

#### 防止跨站目录访问

```php
<?php
// 黑名单过滤
// 这里只演示过滤../实际上不止这些
$black_filepath=array('../');
if (in_array($dir,$black_filepath)){
    echo '<script>alert("禁止目录访问")</script>';
}else{
    show_file($dir);
}
?>
```

#### 绕过方法：

可以使用..../或者..\绕过。

